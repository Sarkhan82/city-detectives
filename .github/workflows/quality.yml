# City Detectives – Quality pipeline (Flutter + Rust)
# Quality gates: dart analyze, format, flutter test; cargo test, clippy, rustfmt

name: Quality

on:
  push:
    branches: [main, master, develop, 'feature/**']
  pull_request:
    branches: [main, master, develop, 'feature/**']
  workflow_dispatch:

jobs:
  flutter:
    name: Flutter (analyze, format, test)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.9"
          channel: "stable"
          cache: true

      - name: Get dependencies
        working-directory: city_detectives
        run: flutter pub get

      - name: Analyze
        working-directory: city_detectives
        run: dart analyze

      - name: Format (check)
        working-directory: city_detectives
        run: dart format --set-exit-if-changed .

      - name: Test
        working-directory: city_detectives
        run: flutter test --coverage

  rust:
    name: Rust (test, clippy, fmt)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # Run only when API exists (hashFiles not available in all contexts)
    continue-on-error: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Skip if no Rust project
        id: skip_rust
        run: |
          if [ ! -f city-detectives-api/Cargo.toml ]; then echo "skip=true" >> $GITHUB_OUTPUT; else echo "skip=false" >> $GITHUB_OUTPUT; fi

      - name: Setup Rust
        if: steps.skip_rust.outputs.skip != 'true'
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Cache Cargo
        if: steps.skip_rust.outputs.skip != 'true'
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: city-detectives-api

      - name: Check format
        if: steps.skip_rust.outputs.skip != 'true'
        working-directory: city-detectives-api
        run: cargo fmt --all -- --check

      - name: Clippy
        if: steps.skip_rust.outputs.skip != 'true'
        working-directory: city-detectives-api
        run: cargo clippy -- -D warnings

      - name: Test (unit)
        if: steps.skip_rust.outputs.skip != 'true'
        working-directory: city-detectives-api
        run: cargo test

      # Tests d'intégration API : serveur sur 8080 puis cargo test -- --ignored
      - name: Integration tests (API server)
        if: steps.skip_rust.outputs.skip != 'true'
        working-directory: city-detectives-api
        run: |
          cargo run &
          SERVER_PID=$!
          for i in $(seq 1 45); do
            if curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:8080/graphql -H "Content-Type: application/json" -d '{"query":"query { health }"}' | grep -q 200; then
              break
            fi
            sleep 1
          done
          cargo test --test auth_test -- --ignored --nocapture
          EXIT=$?
          kill $SERVER_PID 2>/dev/null || true
          exit $EXIT
